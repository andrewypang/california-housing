<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="initial-scale=1.0">
		<meta charset="utf-8">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

		<!-- Include Google Maps JS API -->
		<!-- <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCriTc-URJTbKpAu2HUu4LGL5XEX9cYO8M&callback=initMap" type="text/javascript"></script>-->

		<style type="text/css">

			html, body, #mapDiv {
		        height: 100%;
		        margin: 0;
		        padding: 0;
		        overflow: hidden;
		    }

		    .nicebox {
				position: absolute;
				text-align: center;
				font-family: "Roboto", "Arial", sans-serif;
				font-size: 13px;
				z-index: 5;
				box-shadow: 0 4px 6px -4px #333;
				padding: 5px 10px;
				background: rgb(255,255,255);
				background: linear-gradient(to bottom,rgba(255,255,255,1) 0%,rgba(245,245,245,1) 100%);
				border: rgb(229, 229, 229) 1px solid;
		    }

		    #controls {
				top: 110px;
				left: 10px;
				width: 360px;
				height: 45px;
		    }

		    #data-box {
				top: 10px;
				left: 500px;
				height: 45px;
				line-height: 45px;
				display: none;
		    }


		    #census-variable {
	            width: 360px;
	            height: 20px;
		    }

		    #legend { 
		    	display: flex; 
		    	display: -webkit-box; 
		    	padding-top: 7px 
		    }

		    .color-key {
				background: linear-gradient(to right,
					hsl(5, 69%, 54%) 0%,
					hsl(29, 71%, 51%) 17%,
					hsl(54, 74%, 47%) 33%,
					hsl(78, 76%, 44%) 50%,
					hsl(102, 78%, 41%) 67%,
					hsl(127, 81%, 37%) 83%,
					hsl(151, 83%, 34%) 100%);
				flex: 1;
				-webkit-box-flex: 1;
				margin: 0 5px;
				text-align: left;
				font-size: 1.0em;
				line-height: 1.0em;
		    }

		    #data-value { font-size: 2.0em; font-weight: bold }
			#data-label { font-size: 2.0em; font-weight: normal; padding-right: 10px; }
			#data-label:after { content: ':' }


		    #data-caret { 
		    	margin-left: -5px; 
		    	display: none; 
		    	font-size: 14px; 
		    	width: 14px
		    }


		</style>

		<input id="btnResetZoom" type="button" value="Reset Zoom">
		<input id="btnZoomToSJ"  type="button" value="Zoom To San Jose">
		<input id="btnZoomToSF"  type="button" value="Zoom To San Francisco">
		<input id="btnZoomToLA"  type="button" value="Zoom To Los Angeles">
		<input id="csv-file"     type="file"   name="files" onchange="parseHousingData(this.files)">


	</head>
	<body>

		<div id="mapDiv"></div>

		<div id="controls" class="nicebox">
		  <div>
		  <select id="census-variable">
		  	<option value="None" selected>None</option>
		    <option value="HouseMarkers">HouseMarkers</option>
		    <option value="HeatmapWithPopulation">Heatmap with Population</option>
		  </select>
		  </div>
		  <div id="legend">
		    <div id="census-min">min</div>
		    <div class="color-key"><span id="data-caret">â—†</span></div>
		    <div id="census-max">max</div>
		  </div>
		</div>
		<div id="data-box" class="nicebox">
		  <label id="data-label" for="data-value"></label>
		  <span id="data-value"></span>
		</div>


		<script type="text/javascript">
			var startDate = new Date();

			var CensusDataAPIKey = "42518e77865b671d0fe762fdf3151be2209dd058";
			var ZOOM_OUT = 6;
			var ZOOM_IN = 10;


			//Defining map as a global variable to access from other functions
			var map;
			var dataset_housing = null;

			function initMap(){
				var centerOfCali = new google.maps.LatLng(37.229722, -119.509444);
				var CALIFORNIA_BOUNDS = {
			    	north: 45.296398,
			        south: 25.717281,
			        west: -134.174310,
			        east: -109.663626
			    };

				//Enabling new cartography and themes
				//google.maps.visualRefresh = true;
				//Setting starting options of map
				var mapOptions = {
					center: centerOfCali,
					zoom: ZOOM_OUT,
					maxZoom: ZOOM_IN+3,
					minZoom: ZOOM_OUT,
					restriction: {
						latLngBounds: CALIFORNIA_BOUNDS,
						strictBounds: false,
					},
					disableDoubleClickZoom: true,
					mapTypeId: google.maps.MapTypeId.ROADMAP
				};
				//Getting map DOM element
				var mapElement = document.getElementById('mapDiv');
				//Creating a map with DOM element which is just obtained
				map = new google.maps.Map(mapElement, mapOptions);

				// wire up the button
		        var selectBox = document.getElementById('census-variable');
		        google.maps.event.addDomListener(selectBox, 'change', function() {
	                clearCensusData();
	                loadCensusData(selectBox.options[selectBox.selectedIndex].value);
	            });



				parseGeoJSON();

				var endDate   = new Date();
				console.log("Secs:"+(endDate.getTime() - startDate.getTime()) / 1000);


			}

			/** Removes census data from each shape on the map and resets the UI. */
			function clearCensusData() {
				censusMin = Number.MAX_VALUE;
				censusMax = -Number.MAX_VALUE;
				map.data.forEach(function(row){
					row.setProperty('census_variable', undefined);
				});
				document.getElementById('data-box').style.display = 'none';
				document.getElementById('data-caret').style.display = 'none';
			}

			function loadCensusData(variable) {
				if(variable == "HeatmapWithPopulation")
				{
					console.log(dataset_housing);
				}
				else if(variable == "HouseMarkers")
				{

				}
			}


			function resetZoom() {
				centerOfCali = map.center;
				map.setCenter(centerOfCali);
				map.setZoom(ZOOM_OUT);
			}

			function zoomToSanJose() {
			       var SanJose = new google.maps.LatLng(37.333333, -121.9);
			       map.setCenter(SanJose);
			       map.setZoom(ZOOM_IN);
			}

			function zoomToSanFrancisco() {
			       var SanFrancisco = new google.maps.LatLng(37.783333, -122.416667);
			       map.setCenter(SanFrancisco);
			       map.setZoom(ZOOM_IN);
			}

			function zoomToLosAngeles() {
			       var LosAngeles = new google.maps.LatLng(34.05, -118.25);
			       map.setCenter(LosAngeles);
			       map.setZoom(ZOOM_IN);
			}

			function startButtonEvents () {
				document.getElementById('btnResetZoom').addEventListener('click', function(){ resetZoom(); });
				document.getElementById('btnZoomToSJ').addEventListener('click', function(){ zoomToSanJose(); });
				document.getElementById('btnZoomToSF').addEventListener('click', function(){ zoomToSanFrancisco(); });
				document.getElementById('btnZoomToLA').addEventListener('click', function(){ zoomToLosAngeles(); });
			}

			startButtonEvents();

			/*function drawGeometry(geom){
				if(geom.type == 'Point'){
				    var coordinate = new google.maps.LatLng(geom.coordinates[1], geom.coordinates[0]);
				    var marker = new google.maps.Marker({
				    	position: coordinate,
				    	map: map,
				    	title: 'Marker'
					});
				}
				else if(geom.type == 'LineString'){
					var pointCount = geom.coordinates.length;
					var linePath = [];
					for (var i=0; i < pointCount; i++) {
						var tempLatLng = new google.maps.LatLng(geom.coordinates[i][1], geom.coordinates[i][0]);
						linePath.push(tempLatLng);
					}
					var lineOptions = {
						path: linePath,
						strokeWeight: 7,
						strokeColor: '#19A3FF',
						strokeOpacity: 0.8,
						map: map
					};
					var polyline = new google.maps.Polyline(lineOptions);
				}
				else if(geom.type == 'Polygon'){
					var pointCount = geom.coordinates[0].length;
					var areaPath = [];
					for (var i=0; i < pointCount; i++) {
						var tempLatLng = new google.maps.LatLng(geom.coordinates[0][i][1], geom.coordinates[0][i][0]);
						areaPath.push(tempLatLng);
					}
					var polygonOptions = {
						paths: areaPath,
						strokeColor: '#FF0000',
						strokeOpacity: 0.9,
						strokeWeight: 3,
						fillColor: '#FFFF00',
						fillOpacity: 0.25,
						map: map };
					var polygon = new google.maps.Polygon(polygonOptions);
				}
				else if(geom.type == 'MultiPolygon'){
					console.log(geom.coordinates.length);
					for (var j = 0; j < geom.coordinates.length; j++) {
						var areaPath = [];
						for (var i=0; i < geom.coordinates[j].length; i++) {
							var tempLatLng = new google.maps.LatLng(geom.coordinates[j][i][1], geom.coordinates[j][i][0]);
							areaPath.push(tempLatLng);
						}
					}
					
					var polygonOptions = {
						paths: areaPath,
						strokeColor: '#FFFF00',
						strokeOpacity: 0.9,
						strokeWeight: 3,
						fillColor: '#FFFFF0',
						fillOpacity: 0.25,
						map: map };
					var polygon = new google.maps.Polygon(polygonOptions);
				}
				else{
					console.log("Error:" + geom.type);
				}
			} */

			function parseGeoJSON() {
				$.ajax({
				    type: "POST",
				    url: "shapes/county-subdivision.json",
				    contentType: "application/json; charset=utf-8",
				    dataType: "json",
				    success: function(json) {
				    	map.data.addGeoJson(json);
				    },
				    error: function (xhr, textStatus, errorThrown) {
				        console.log("parseGeoJSON: Error: " + xhr + textStatus);
				    }
				});

				// Color each letter gray. Change the color when the isColorful property
		        // is set to true.
		        map.data.setStyle(function(feature) {
		          var color = 'blue';
		          if (feature.getProperty('isColorful')) {
		            color = "red";
		          }
		          return /** @type {!google.maps.Data.StyleOptions} */({
		            fillColor: color,
		            strokeColor: color,
		            strokeWeight: 2
		          });
		        });

		        // When the user clicks, set 'isColorful', changing the color of the letters.
		        map.data.addListener('click', function(event) {
		        	//event.feature.setProperty('isColorful', true);
		        	event.feature.setProperty('isColorful', !(event.feature.getProperty('isColorful')) );
		        });

		        // https://api.census.gov/data
			}

			function parseHousingData(evt) {

				const selectedFile = document.getElementById('csv-file').files[0];

				var config = {
			      header: true,
			      dynamicTyping: true,
			      complete: function(results) {
			        console.log(results);
			        dataset_housing = results;
			        var markers = [];
			        results.data.forEach( function(entry) {
			        	var entry_position = new google.maps.LatLng(entry.latitude, entry.longitude);

			        	var MarkerOptions = {
			        		position: entry_position,
			        		opacity: 0.5,
			        		map: map
			        	};
			        	var marker = new google.maps.Marker(MarkerOptions);

			        	markers.push(marker);
			        });
			        var markerCluster = new MarkerClusterer(map, markers, {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m', zoomOnClick: false });
			      } // End of complete: function()
			    } // End of config

				Papa.parse(selectedFile, config);
			}

		</script>
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCriTc-URJTbKpAu2HUu4LGL5XEX9cYO8M&libraries=visualization&callback=initMap" async defer> </script>
		<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"> </script>
		<script src="papaparse.min.js"></script>
	</body>
</html>
