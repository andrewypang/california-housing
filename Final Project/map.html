<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="initial-scale=1.0">
		<meta charset="utf-8">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

		<!-- Include Google Maps JS API -->
		<!-- <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCriTc-URJTbKpAu2HUu4LGL5XEX9cYO8M&callback=initMap" type="text/javascript"></script>-->

		<style type="text/css">

			html, body, #mapDiv {
		        height: 100%;
		        margin: 0;
		        padding: 0;
		        overflow: hidden;
		    }

		    .nicebox {
				position: absolute;
				text-align: center;
				font-family: "Roboto", "Arial", sans-serif;
				font-size: 14px;
				z-index: 5;
				box-shadow: 0 4px 6px -4px #333;
				padding: 5px 10px;
				background: rgb(255,255,255);
				background: linear-gradient(to bottom,rgba(255,255,255,1) 0%,rgba(245,245,245,1) 100%);
				border: rgb(229, 229, 229) 1px solid;
		    }

		    #controls {
				top: 110px;
				left: 10px;
				width: 360px;
				height: 45px;
		    }

		    #data-box {
				top: 180px;
				left: 10px;
				text-align: center;
				display: block;
				width: 360px;
								border: rgb(229, 0, 50) 3px solid;
		    }


		    #census-variable {
	            width: 360px;
	            height: 20px;
		    }

		    #legend { 
		    	display: flex; 
		    	display: -webkit-box; 
		    	padding-top: 7px 
		    }

		    .color-key {
				background: linear-gradient(to left,
					hsl(5, 69%, 54%) 0%,
					hsl(29, 71%, 51%) 17%,
					hsl(54, 74%, 47%) 33%,
					hsl(78, 76%, 44%) 50%,
					hsl(102, 78%, 41%) 67%,
					hsl(127, 81%, 37%) 83%,
					hsl(151, 83%, 34%) 100%);
				flex: 1;
				-webkit-box-flex: 1;
				margin: 0 5px;
				text-align: left;
				font-size: 1.0em;
				line-height: 1.0em;
		    }

			#hover-label { 
				font-size: 14px; 
				font-weight: bold; 
				width: 200px;
				line-height: 20px;
				display: inline-block;
			}
			#hover-value { font-size: 14px; font-weight: bold }

		    #data-caret { 
		    	margin-left: -5px; 
		    	display: none; 
		    	font-size: 14px; 
		    	width: 14px
		    }

		    #selected-county {
		    	overflow: auto;
		    	max-height:400px;
		    	border: rgb(229, 0, 50) 3px solid;

		    }

		    .county-stats {
		    	background-color: rgba(255, 255, 255, 1.0);
		    	text-align: left;
		    	padding-right: 30px;

		    }

		    .county {
		    			    	border: rgb(229, 0, 50) 0px solid;
		    }


		</style>

		<input id="btnResetZoom" type="button" value="Reset Zoom">
		<input id="btnZoomToSC"  type="button" value="Zoom To Santa Cruz">
		<input id="btnZoomToSJ"  type="button" value="Zoom To San Jose">
		<input id="btnZoomToSF"  type="button" value="Zoom To San Francisco">
		<input id="btnZoomToLA"  type="button" value="Zoom To Los Angeles">
		<input id="btnUpdateDataDisplay"  type="button" value="Update">
		<input id="csv-file"     type="file"   name="files" onchange="loadHousingData(this.files)">


	</head>
	<body>

		<div id="mapDiv"></div>

		<div id="controls" class="nicebox">
		  <div>
		  <select disabled id="census-variable">
		  	<option value="None" selected="selected">None</option>
		    <option value="HouseMarkers">House Markers</option>
		    <option value="HeatmapWithPopulation">Heatmap with Population</option>
		    <option value="HeatmapWithMedianIncome">Heatmap with Median-Income</option>
		    <option value="HeatmapWithMedianHouseValue">Heatmap with Median House Value</option>


		  </select>
		  </div>
		  <div id="legend">
		    <div id="census-min">min</div>
		    <div class="color-key"><span id="data-caret">â—†</span></div>
		    <div id="census-max">max</div>
		  </div>
		</div>
		<div id="data-box" class="nicebox">
		  <span id="hover-label"></span>

		  <div id="selected-county"> </div>

		</div>


		<script type="text/javascript">
			var startDate = new Date();

			var CensusDataAPIKey = "42518e77865b671d0fe762fdf3151be2209dd058";
			var ZOOM_OUT = 6;
			var ZOOM_IN = 9;


			//Defining map as a global variable to access from other functions
			var map;
			var dataset_housing = null;
			var housingCluster = null;
			var heatmap = null;
			var dataLayer = [];

			function initMap(){
				var centerOfCali = new google.maps.LatLng(37.229722, -119.509444);
				var CALIFORNIA_BOUNDS = {
			    	north: 45.296398,
			        south: 25.717281,
			        west: -134.174310,
			        east: -109.663626
			    };

				//Enabling new cartography and themes
				//google.maps.visualRefresh = true;
				//Setting starting options of map
				var mapOptions = {
					center: centerOfCali,
					zoom: ZOOM_OUT,
					minZoom: ZOOM_OUT,
					restriction: {
						latLngBounds: CALIFORNIA_BOUNDS,
						strictBounds: false,
					},
					disableDoubleClickZoom: true,
					mapTypeId: google.maps.MapTypeId.ROADMAP
				};
				//Getting map DOM element
				var mapElement = document.getElementById('mapDiv');
				//Creating a map with DOM element which is just obtained
				map = new google.maps.Map(mapElement, mapOptions);

				// wire up the button
		        var selectBox = document.getElementById('census-variable');
		        google.maps.event.addDomListener(selectBox, 'change', function() {
	                clearCensusData();
	                loadCensusData(selectBox.options[selectBox.selectedIndex].value);
	            });

	            google.maps.event.addDomListener(selectBox, 'zoom_changed', function() {
	      
	            });

				parseGeoJSON();

				$(document).ready()
				{
					var endDate   = new Date();
					console.log("Secs:"+(endDate.getTime() - startDate.getTime()) / 1000);
				}


			}

			/** Removes census data from each shape on the map and resets the UI. */
			function clearCensusData() {
				censusMin = Number.MAX_VALUE;
				censusMax = -Number.MAX_VALUE;
				map.data.forEach(function(row){
					row.setProperty('census_variable', undefined);
				});
				document.getElementById('data-box').style.display = 'none';
				document.getElementById('data-caret').style.display = 'none';

				//Clear markers and heatmap
				if(housingCluster != null)
				{
					housingCluster.clearMarkers();
				}
				if(heatmap != null)
				{
					//heatmap.getMap() != null
					heatmap.setMap(null);
				}
				if(dataLayer.length != 0)
				{
					for(var i = 0; i < dataLayer.length; i++)
					{
						dataLayer[i].setMap(null);
						dataLayer[i] = null;
					}
					dataLayer = [];
				}
			}

			function loadCensusData(variable) {
				var dataMin = Number.MAX_VALUE;
				var dataMinName = "";
				var dataMax = -Number.MAX_VALUE;
				var dataMaxName = "";
				var dataMinMarker;
				var dataMaxMarker;

				if(variable == "None")
				{

				}
				else if(variable == "HouseMarkers")
				{
					var markers = [];
					dataset_housing.data.forEach( function(entry) {
						var entry_position = new google.maps.LatLng(entry.latitude, entry.longitude);

						var MarkerOptions = {
							position: entry_position,
							opacity: 0.5,
							map: map
						};
						var marker = new google.maps.Marker(MarkerOptions);

						markers.push(marker);
					});
					var MarkerClustererOptions = {
						imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m', 
						zoomOnClick: false, 
						minimumClusterSize: 3
					};
					housingCluster = new MarkerClusterer(map, markers, MarkerClustererOptions);
					console.log("Success! Loaded House Markers");
				}
				else if(variable == "HeatmapWithPopulation")
				{
					var heatmapData = [];
					var dataMinMarker;
					var dataMaxMarker;
					var dataMinLocation;
					var dataMaxLocation;
					var dataMinMarkerOptions;
					var dataMaxMarkerOptions;

					dataset_housing.data.forEach( function(entry)
					{
						var entry_position = new google.maps.LatLng(entry.latitude, entry.longitude);

						var weightedLoc = {
						    location: entry_position,
						    weight: entry.population
						};

						heatmapData.push(weightedLoc);

						// Final Min and Max
						if(entry.population < dataMin)
						{
							dataMin = entry.population;
							dataMinLocation = new google.maps.LatLng(entry.latitude, entry.longitude);
							dataMinMarkerOptions = {
								position: dataMinLocation,
								opacity: 0.7,
								icon: { url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png" },
								map: map
							};
						}
						if(entry.population > dataMax)
						{
							dataMax = entry.population;
							dataMaxLocation = new google.maps.LatLng(entry.latitude, entry.longitude);
							dataMaxMarkerOptions = {
								position: dataMaxLocation,
								opacity: 0.7,
								icon: { url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" },
								map: map
							};
						}
					});

					heatmap = new google.maps.visualization.HeatmapLayer({
						data: heatmapData,
						dissipating: true,
						radius: 20,
						map: map
					});

					dataMinMarker = new google.maps.Marker(dataMinMarkerOptions);
					dataMaxMarker = new google.maps.Marker(dataMaxMarkerOptions);
					dataLayer.push(dataMinMarker);
					dataLayer.push(dataMaxMarker);

					console.log("Success! Loaded Heatmap With Population");
				}
				else if(variable == "HeatmapWithMedianIncome")
				{
					var heatmapData = [];
					dataset_housing.data.forEach( function(entry)
					{
						var entry_position = new google.maps.LatLng(entry.latitude, entry.longitude);

						var weightedLoc = {
						    location: entry_position,
						    weight: entry.median_income
						};

						heatmapData.push(weightedLoc);

						if(entry.median_income < dataMin)
						{
							dataMin = entry.median_income;
						}
						if(entry.median_income > dataMax)
						{
							dataMax = entry.median_income;
						}
					});

					heatmap = new google.maps.visualization.HeatmapLayer({
						data: heatmapData,
						dissipating: true,
						radius: 20,
						map: map
					});

					console.log("Success! Loaded Heatmap With Median-Income");
				}
				else if(variable == "HeatmapWithMedianHouseValue")
				{
					var heatmapData = [];
					dataset_housing.data.forEach( function(entry)
					{
						var entry_position = new google.maps.LatLng(entry.latitude, entry.longitude);

						var weightedLoc = {
						    location: entry_position,
						    weight: entry.median_house_value
						};

						heatmapData.push(weightedLoc);

						if(entry.median_house_value < dataMin)
						{
							dataMin = entry.median_house_value;
						}
						if(entry.median_house_value > dataMax)
						{
							dataMax = entry.median_house_value;
						}
					});

					heatmap = new google.maps.visualization.HeatmapLayer({
						data: heatmapData,
						dissipating: true,
						radius: 20,
						map: map
					});

					console.log("Success! Loaded Heatmap With Median House Value");
				}

				if( dataMin != Number.MAX_VALUE || dataMax != -Number.MAX_VALUE)
				{
					// update and display the legend
					document.getElementById('census-min').textContent = dataMin.toLocaleString();
					document.getElementById('census-max').textContent = dataMax.toLocaleString();

					document.getElementById('data-box').style.display = 'block';
				}
				else
				{
					// reset back to default min & max
					document.getElementById('census-min').textContent = "min";
					document.getElementById('census-max').textContent = "max";
					document.getElementById('data-box').style.display = 'none';
				}


			}


			function resetZoom() {
				centerOfCali = map.center;
				map.setCenter(centerOfCali);
				map.setZoom(ZOOM_OUT);
			}
			
			function zoomToSantaCruz() {
			       var SantaCruz = new google.maps.LatLng(36.971944, -122.026389);
			       map.setCenter(SantaCruz);
			       map.setZoom(ZOOM_IN);
			}

			function zoomToSanJose() {
			       var SanJose = new google.maps.LatLng(37.333333, -121.9);
			       map.setCenter(SanJose);
			       map.setZoom(ZOOM_IN);
			}

			function zoomToSanFrancisco() {
			       var SanFrancisco = new google.maps.LatLng(37.783333, -122.416667);
			       map.setCenter(SanFrancisco);
			       map.setZoom(ZOOM_IN);
			}

			function zoomToLosAngeles() {
			       var LosAngeles = new google.maps.LatLng(34.05, -118.25);
			       map.setCenter(LosAngeles);
			       map.setZoom(ZOOM_IN);
			}

			function updateDataDisplay() {

				var list = document.getElementById("selected-county");
				while (list.firstChild)
				{
				    list.removeChild(list.firstChild);
				}


		     	//Get headers
		     	var subcounty_housing_median_age = subcounty_total_rooms = subcounty_total_bedrooms = subcounty_population = subcounty_households = subcounty_median_income = subcounty_median_house_value = subcounty_ocean_proximity = 0;
	         	var entryCount = 0;
				map.data.forEach(function(feature) {
					if(feature.getProperty('isColorful'))
					{
						console.log(feature.getProperty('NAME') + " is selected");

						if(feature.getGeometry().getType() === 'Polygon')
						{
							var polyPath = feature.getGeometry().getAt(0).getArray();
	        				var poly = new google.maps.Polygon({
	        					paths: polyPath
	        				});

	        				dataset_housing.data.forEach( function(entry) {

	        					var entry_position = new google.maps.LatLng(entry.latitude, entry.longitude);

	        					if(google.maps.geometry.poly.containsLocation(entry_position, poly))
	        					{
	        						entryCount += 1;
	        						subcounty_housing_median_age += entry.housing_median_age; 
	        						subcounty_total_rooms += entry.total_rooms;
	        						subcounty_total_bedrooms += entry.total_bedrooms;
	        						subcounty_population += entry.population;
	        						subcounty_households += entry.households;
	        						subcounty_median_income += entry.median_income;
	        						subcounty_median_house_value += entry.median_house_value;
	        						subcounty_ocean_proximity += entry.ocean_proximity;
	        					}

	        				});

	        				var countyList = document.getElementById("selected-county");

	        				var county = document.createElement('div');
	        				county.setAttribute("class", "county");

	        				// Create the County Name label
	        				var countyName = document.createElement('label');
	        				countyName.appendChild( document.createTextNode(feature.getProperty('NAME')) );
	        				county.appendChild(countyName);

	        				// Create the County Stats list
	        				var countyStats = document.createElement('ul');
	        				countyStats.setAttribute("class", "county-stats");

	        				var li = document.createElement("li");
	        				li.appendChild(document.createTextNode( "Number of Data Points: " + entryCount.toLocaleString() ));
	        				countyStats.appendChild(li);

	        				var li = document.createElement("li");
	        				li.appendChild(document.createTextNode( "Population: " + subcounty_population.toLocaleString() ));
	        				countyStats.appendChild(li);

	        				var li = document.createElement("li");
	        				li.appendChild(document.createTextNode( "Median Income: " + ((subcounty_median_income/entryCount)*10000).toLocaleString() ));
	        				countyStats.appendChild(li);

	        				var li = document.createElement("li");
	        				li.appendChild(document.createTextNode( "Median House Value: " + (subcounty_median_house_value/entryCount).toLocaleString() ));
	        				countyStats.appendChild(li);

	        				county.appendChild(countyStats);

	        				countyList.appendChild(county);
						}
		     			else
		     			{
		     				console.log("Need fix:" + event.feature.getGeometry().getType());
		     			}

					}
				});
			       
			}

			function startButtonEvents () {
				document.getElementById('btnResetZoom').addEventListener('click', function(){ resetZoom(); });
				document.getElementById('btnZoomToSC').addEventListener('click', function(){ zoomToSantaCruz(); });
				document.getElementById('btnZoomToSJ').addEventListener('click', function(){ zoomToSanJose(); });
				document.getElementById('btnZoomToSF').addEventListener('click', function(){ zoomToSanFrancisco(); });
				document.getElementById('btnZoomToLA').addEventListener('click', function(){ zoomToLosAngeles(); });
				document.getElementById('btnUpdateDataDisplay').addEventListener('click', function(){ updateDataDisplay(); });
				
			}

			startButtonEvents();

			function parseGeoJSON() {
				$.ajax({
				    type: "POST",
				    url: "shapes/county-subdivision.json",
				    contentType: "application/json; charset=utf-8",
				    dataType: "json",
				    success: function(json) {
				    	map.data.addGeoJson(json);
				    },
				    error: function (xhr, textStatus, errorThrown) {
				        console.log("parseGeoJSON: Error: " + xhr + textStatus);
				    }
				});

				// Color each letter gray. Change the color when the isColorful property
		        // is set to true.
		        map.data.setStyle(function(feature) {
		          var color = 'blue';
		          if (feature.getProperty('isColorful')) {
		            color = "red";
		          }
		          return /** @type {!google.maps.Data.StyleOptions} */({
		            fillColor: color,
		            strokeColor: color,
		            fillOpacity: 0.1,
		            strokeOpacity: 0.1,
		            strokeWeight: 2
		          });
		        });

		        // When the user clicks, set 'isColorful', changing the color
		        map.data.addListener('click', function(event) {
		        	event.feature.setProperty('isColorful', !(event.feature.getProperty('isColorful')) );

		        }); // End of map.data.addListener('click', function(event)

		        // Set mouseover event for each feature.
		        map.data.addListener('mouseover', function(event) {
		        	document.getElementById('hover-label').textContent = event.feature.getProperty('NAME');
		        });

		        map.data.addListener('mouseout', function(event) {
		        	document.getElementById('hover-label').textContent = "";
		        });

			}

			function loadHousingData(evt) {

				const selectedFile = document.getElementById('csv-file').files[0];

				var config = {
			      header: true,
			      dynamicTyping: true,
			      complete: function(results) {
			        console.log("Success! Loaded " + selectedFile.name);
			        dataset_housing = results;			        
			      } // End of complete: function()
			    } // End of config

				Papa.parse(selectedFile, config);

				document.getElementById("census-variable").disabled = false;
				document.getElementById("data-box").style.display = 'block';
			}

		</script>
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCriTc-URJTbKpAu2HUu4LGL5XEX9cYO8M&libraries=visualization&callback=initMap" async defer> </script>
		<script src="markerclusterer.js"> </script>
		<script src="papaparse.min.js"></script>
	</body>
</html>
